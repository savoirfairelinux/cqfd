#!/usr/bin/env bash
#
# validate the behavior of custom image

set -o pipefail

. "$(dirname "$0")"/jtest.inc "$1"
cqfd="$TDIR/.cqfd/cqfd"
cqfd_docker="${CQFD_DOCKER:-docker}"

cd "$TDIR/" || exit 1

cp -f .cqfd/docker/Dockerfile .cqfd/docker/Dockerfile.old
cp -f .cqfd/docker/Dockerfile.init_custom_image .cqfd/docker/Dockerfile
cp -f .cqfdrc .cqfdrc.old
cp -f cqfdrc-custom_image .cqfdrc

################################################################################
# 'cqfd' pulls custom_img_name
################################################################################
custom_img_name="ubuntu:16.04"
sed -i -e "s!^custom_img_name=.*\$!custom_img_name='$custom_img_name'!" .cqfdrc
if "$cqfd_docker" inspect "$custom_img_name" &>/dev/null; then
	jtest_log info "$cqfd_docker registry contains image named: $custom_img_name, removing..."
	"$cqfd_docker" rmi "$custom_img_name"
fi

jtest_prepare "cqfd pulls image $custom_img_name from registry"
if "$cqfd" | grep -qE "Ubuntu 16.04(.[[:digit:]]+)? LTS"; then
	jtest_result pass
else
	jtest_result fail
fi

################################################################################
# 'cqfd init' with custom_img_name
################################################################################
custom_img_name="cqfd_test_custom_image_$RANDOM$RANDOM"
sed -i -e "s!^custom_img_name=.*\$!custom_img_name='$custom_img_name'!" .cqfdrc
jtest_log info "$cqfd_docker registry contains NO image named: $custom_img_name"
if "$cqfd_docker" inspect "$custom_img_name" &>/dev/null; then
	jtest_log info "$cqfd_docker registry contains image named: $custom_img_name, removing..."
	"$cqfd_docker" rmi "$custom_img_name"
fi

jtest_prepare "cqfd fails pulling inexistant image $custom_img_name from registry"
if ! "$cqfd"; then
	jtest_result pass
else
	jtest_result fail
fi

jtest_prepare "cqfd init works using custom_img_name=$custom_img_name"
if "$cqfd" init; then
	jtest_result pass
else
	jtest_result fail
fi

jtest_prepare "$cqfd_docker registry contains image named: $custom_img_name"
if "$cqfd_docker" inspect "$custom_img_name" &>/dev/null; then
	jtest_result pass
else
	jtest_result fail
fi

jtest_prepare "cqfd runs created image $custom_img_name"
if "$cqfd" | grep -qE "Ubuntu 24.04(.[[:digit:]]+)? LTS"; then
	jtest_result pass
else
	jtest_result fail
fi

# cleanup
"$cqfd_docker" rmi "$custom_img_name"

################################################################################
# Restore initial .cqfdrc and Dockerfile
################################################################################
mv -f .cqfdrc.old .cqfdrc
mv -f .cqfd/docker/Dockerfile.old .cqfd/docker/Dockerfile
